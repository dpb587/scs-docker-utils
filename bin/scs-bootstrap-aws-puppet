#!/bin/bash

# args: region stack resource setup-script

set -e

# puppet
wget https://apt.puppetlabs.com/puppetlabs-release-saucy.deb
dpkg -i puppetlabs-release-saucy.deb
rm puppetlabs-release-saucy.deb
apt-get update

# core tools
apt-get -y install git puppet python-pip

# node
mkdir /usr/local/nodejs
pushd /usr/local/nodejs
wget -O- http://nodejs.org/dist/v0.10.25/node-v0.10.25-linux-x64.tar.gz | tar -xz --strip-components 1
ln -s $PWD/bin/* /usr/bin/
popd

# scs-utils
mkdir /usr/local/scs-utils
pushd /usr/local/scs-utils
wget -O- https://github.com/dpb587/scs-docker-utils/archive/master.tar.gz | tar -xz --strip-components 1
pip install --upgrade -r requirements.txt
npm install
( cd node_modules/node-etcd/ && npm install && npm run-script build )
ln -s $PWD/bin/* /usr/bin/
popd

# cfn-bootstrap
pip install https://s3.amazonaws.com/cloudformation-examples/aws-cfn-bootstrap-latest.tar.gz
cfn-init --verbose --region "$1" --stack "$2" --resource "$3"

# optional custom script
if [ "" != $4 ]; then
    $4
fi

# puppet
sed -i 's/START=no/START=yes/' /etc/default/puppet
service puppet start
